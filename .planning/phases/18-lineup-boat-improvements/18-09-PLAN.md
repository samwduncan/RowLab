---
phase: 18-lineup-boat-improvements
plan: 09
type: execute
wave: 4
depends_on: ["18-07"]
files_modified:
  - src/v2/features/lineup/components/TemplateManager.tsx
  - src/v2/features/lineup/components/LineupComparison.tsx
  - src/v2/features/lineup/components/index.ts
autonomous: true

must_haves:
  truths:
    - "Template manager allows saving, listing, and applying templates"
    - "Lineup comparison shows two lineups side-by-side with differences highlighted"
    - "Template application resolves athlete assignments"
  artifacts:
    - path: "src/v2/features/lineup/components/TemplateManager.tsx"
      provides: "Template save/load/apply UI"
      min_lines: 150
    - path: "src/v2/features/lineup/components/LineupComparison.tsx"
      provides: "Side-by-side lineup comparison"
      min_lines: 100
  key_links:
    - from: "src/v2/features/lineup/components/TemplateManager.tsx"
      to: "src/v2/hooks/useLineupTemplates.ts"
      via: "Template hooks"
      pattern: "useLineupTemplates"
---

<objective>
Create template manager and lineup comparison components.

Purpose: Enable coaches to save/apply lineup templates and compare lineups side-by-side.
Output: Two UI components for template management and visual lineup comparison.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/18-lineup-boat-improvements/18-RESEARCH.md
@src/v2/hooks/useLineupTemplates.ts
@src/v2/types/lineupTemplate.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TemplateManager component</name>
  <files>src/v2/features/lineup/components/TemplateManager.tsx</files>
  <action>
Create `src/v2/features/lineup/components/TemplateManager.tsx`:

```typescript
/**
 * TemplateManager - Phase 18 LINEUP-03
 *
 * Manages lineup templates: save current lineup as template,
 * list existing templates, and apply templates to create lineups.
 */

import { useState } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import {
  FileStack,
  Plus,
  Trash2,
  Star,
  StarOff,
  ChevronDown,
  ChevronUp,
  Play,
} from 'lucide-react';
import {
  useLineupTemplates,
  useCreateTemplate,
  useDeleteTemplate,
  useApplyTemplate,
  useUpdateTemplate,
} from '@v2/hooks/useLineupTemplates';
import type { LineupTemplate, TemplateAssignment } from '@v2/types/lineupTemplate';

interface TemplateManagerProps {
  boatClass?: string;
  currentAssignments?: TemplateAssignment[];
  onApplyTemplate: (result: {
    templateName: string;
    assignedAthletes: Array<{
      seatNumber: number;
      athleteId: string;
      athleteName: string;
      side: 'Port' | 'Starboard';
    }>;
    unfilledSeats: number[];
  }) => void;
  className?: string;
}

interface SaveTemplateDialogProps {
  boatClass: string;
  assignments: TemplateAssignment[];
  onSave: (name: string, isDefault: boolean) => void;
  onCancel: () => void;
}

function SaveTemplateDialog({
  boatClass,
  assignments,
  onSave,
  onCancel,
}: SaveTemplateDialogProps) {
  const [name, setName] = useState('');
  const [isDefault, setIsDefault] = useState(false);

  const handleSubmit = (e: React.FormEvent) => {
    e.preventDefault();
    if (name.trim()) {
      onSave(name.trim(), isDefault);
    }
  };

  return (
    <motion.div
      initial={{ opacity: 0, y: -10 }}
      animate={{ opacity: 1, y: 0 }}
      exit={{ opacity: 0, y: -10 }}
      className="p-3 bg-bg-default border border-bdr-default rounded-lg"
    >
      <form onSubmit={handleSubmit} className="space-y-3">
        <div>
          <label className="block text-sm font-medium text-txt-primary mb-1">
            Template Name
          </label>
          <input
            type="text"
            value={name}
            onChange={(e) => setName(e.target.value)}
            placeholder={`${boatClass} Template...`}
            className="w-full px-3 py-2 text-sm rounded border border-bdr-default
                       bg-bg-elevated focus:outline-none focus:ring-2 focus:ring-interactive-primary"
            autoFocus
          />
        </div>

        <label className="flex items-center gap-2 text-sm text-txt-secondary">
          <input
            type="checkbox"
            checked={isDefault}
            onChange={(e) => setIsDefault(e.target.checked)}
            className="rounded border-bdr-default"
          />
          Set as default for {boatClass}
        </label>

        <div className="flex justify-end gap-2">
          <button
            type="button"
            onClick={onCancel}
            className="px-3 py-1.5 text-sm text-txt-secondary hover:text-txt-primary
                       hover:bg-bg-hover rounded transition-colors"
          >
            Cancel
          </button>
          <button
            type="submit"
            disabled={!name.trim()}
            className="px-3 py-1.5 text-sm text-white bg-interactive-primary
                       hover:bg-interactive-primary-hover rounded transition-colors
                       disabled:opacity-50 disabled:cursor-not-allowed"
          >
            Save Template
          </button>
        </div>
      </form>
    </motion.div>
  );
}

function TemplateCard({
  template,
  onApply,
  onDelete,
  onToggleDefault,
  isApplying,
}: {
  template: LineupTemplate;
  onApply: () => void;
  onDelete: () => void;
  onToggleDefault: () => void;
  isApplying: boolean;
}) {
  return (
    <div className="p-3 border border-bdr-default rounded-lg bg-bg-default hover:border-bdr-hover transition-colors">
      <div className="flex items-start justify-between">
        <div className="flex-1">
          <div className="flex items-center gap-2">
            <h4 className="font-medium text-txt-primary">{template.name}</h4>
            {template.isDefault && (
              <span className="text-xs px-1.5 py-0.5 rounded bg-blue-500/10 text-blue-500">
                Default
              </span>
            )}
          </div>
          <p className="text-xs text-txt-tertiary mt-0.5">
            {template.boatClass} • {template.assignments.length} seats
          </p>
          {template.description && (
            <p className="text-xs text-txt-secondary mt-1">{template.description}</p>
          )}
        </div>

        <div className="flex items-center gap-1">
          <button
            onClick={onToggleDefault}
            className="p-1.5 text-txt-tertiary hover:text-amber-500 rounded
                       hover:bg-bg-hover transition-colors"
            title={template.isDefault ? 'Remove as default' : 'Set as default'}
          >
            {template.isDefault ? (
              <Star className="h-4 w-4 fill-current text-amber-500" />
            ) : (
              <StarOff className="h-4 w-4" />
            )}
          </button>
          <button
            onClick={onDelete}
            className="p-1.5 text-txt-tertiary hover:text-red-500 rounded
                       hover:bg-bg-hover transition-colors"
            title="Delete template"
          >
            <Trash2 className="h-4 w-4" />
          </button>
        </div>
      </div>

      <button
        onClick={onApply}
        disabled={isApplying}
        className="mt-3 w-full flex items-center justify-center gap-1.5 px-3 py-1.5
                   text-sm text-interactive-primary hover:text-interactive-primary-hover
                   border border-interactive-primary hover:bg-interactive-primary/10
                   rounded transition-colors disabled:opacity-50"
      >
        <Play className="h-3.5 w-3.5" />
        {isApplying ? 'Applying...' : 'Apply Template'}
      </button>
    </div>
  );
}

export function TemplateManager({
  boatClass,
  currentAssignments,
  onApplyTemplate,
  className = '',
}: TemplateManagerProps) {
  const [expanded, setExpanded] = useState(false);
  const [showSaveDialog, setShowSaveDialog] = useState(false);

  const { data: templates, isLoading } = useLineupTemplates(boatClass);
  const createMutation = useCreateTemplate();
  const deleteMutation = useDeleteTemplate();
  const updateMutation = useUpdateTemplate();
  const applyMutation = useApplyTemplate();

  const canSave = currentAssignments && currentAssignments.length > 0 && boatClass;

  const handleSaveTemplate = async (name: string, isDefault: boolean) => {
    if (!boatClass || !currentAssignments) return;

    try {
      await createMutation.mutateAsync({
        name,
        boatClass,
        assignments: currentAssignments,
        isDefault,
      });
      setShowSaveDialog(false);
    } catch (error) {
      console.error('Failed to save template:', error);
    }
  };

  const handleApplyTemplate = async (templateId: string) => {
    try {
      const result = await applyMutation.mutateAsync(templateId);
      onApplyTemplate({
        templateName: result.templateName,
        assignedAthletes: result.assignedAthletes,
        unfilledSeats: result.unfilledSeats,
      });
    } catch (error) {
      console.error('Failed to apply template:', error);
    }
  };

  const handleDeleteTemplate = async (templateId: string) => {
    if (!confirm('Delete this template?')) return;
    try {
      await deleteMutation.mutateAsync(templateId);
    } catch (error) {
      console.error('Failed to delete template:', error);
    }
  };

  const handleToggleDefault = async (template: LineupTemplate) => {
    try {
      await updateMutation.mutateAsync({
        templateId: template.id,
        data: { isDefault: !template.isDefault },
      });
    } catch (error) {
      console.error('Failed to update template:', error);
    }
  };

  return (
    <div className={`bg-bg-elevated rounded-lg border border-bdr-default ${className}`}>
      {/* Header */}
      <button
        onClick={() => setExpanded(!expanded)}
        className="w-full flex items-center justify-between p-3 hover:bg-bg-hover transition-colors"
      >
        <div className="flex items-center gap-2">
          <FileStack className="h-4 w-4 text-txt-secondary" />
          <span className="font-medium text-txt-primary">Templates</span>
          {templates && templates.length > 0 && (
            <span className="text-xs text-txt-tertiary">({templates.length})</span>
          )}
        </div>
        {expanded ? (
          <ChevronUp className="h-4 w-4 text-txt-tertiary" />
        ) : (
          <ChevronDown className="h-4 w-4 text-txt-tertiary" />
        )}
      </button>

      {/* Content */}
      <AnimatePresence>
        {expanded && (
          <motion.div
            initial={{ height: 0, opacity: 0 }}
            animate={{ height: 'auto', opacity: 1 }}
            exit={{ height: 0, opacity: 0 }}
            transition={{ duration: 0.2 }}
            className="overflow-hidden"
          >
            <div className="px-3 pb-3 border-t border-bdr-default">
              {/* Save current as template */}
              <div className="pt-3">
                <AnimatePresence mode="wait">
                  {showSaveDialog && canSave ? (
                    <SaveTemplateDialog
                      key="dialog"
                      boatClass={boatClass!}
                      assignments={currentAssignments!}
                      onSave={handleSaveTemplate}
                      onCancel={() => setShowSaveDialog(false)}
                    />
                  ) : (
                    <motion.button
                      key="button"
                      initial={{ opacity: 0 }}
                      animate={{ opacity: 1 }}
                      exit={{ opacity: 0 }}
                      onClick={() => setShowSaveDialog(true)}
                      disabled={!canSave}
                      className="w-full flex items-center justify-center gap-1.5 px-3 py-2
                                 text-sm border border-dashed border-bdr-default rounded
                                 hover:border-interactive-primary hover:text-interactive-primary
                                 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                      <Plus className="h-4 w-4" />
                      Save Current as Template
                    </motion.button>
                  )}
                </AnimatePresence>
              </div>

              {/* Template list */}
              <div className="mt-3 space-y-2 max-h-80 overflow-y-auto">
                {isLoading ? (
                  <div className="animate-pulse space-y-2">
                    <div className="h-24 rounded bg-bg-hover" />
                    <div className="h-24 rounded bg-bg-hover" />
                  </div>
                ) : templates && templates.length > 0 ? (
                  templates.map((template) => (
                    <TemplateCard
                      key={template.id}
                      template={template}
                      onApply={() => handleApplyTemplate(template.id)}
                      onDelete={() => handleDeleteTemplate(template.id)}
                      onToggleDefault={() => handleToggleDefault(template)}
                      isApplying={applyMutation.isPending}
                    />
                  ))
                ) : (
                  <p className="text-sm text-txt-tertiary py-4 text-center">
                    No templates saved{boatClass ? ` for ${boatClass}` : ''}
                  </p>
                )}
              </div>
            </div>
          </motion.div>
        )}
      </AnimatePresence>
    </div>
  );
}

export default TemplateManager;
```
  </action>
  <verify>Run `npx tsc --noEmit src/v2/features/lineup/components/TemplateManager.tsx` - should compile without errors.</verify>
  <done>TemplateManager component created with save/load/apply functionality.</done>
</task>

<task type="auto">
  <name>Task 2: Create LineupComparison component</name>
  <files>src/v2/features/lineup/components/LineupComparison.tsx</files>
  <action>
Create `src/v2/features/lineup/components/LineupComparison.tsx`:

```typescript
/**
 * LineupComparison - Phase 18 LINEUP-01
 *
 * Side-by-side comparison of two lineups with difference highlighting.
 * Simple seat-by-seat comparison (not complex diff algorithm).
 */

import { useMemo } from 'react';
import { motion } from 'framer-motion';
import { ArrowLeftRight, User, UserMinus, UserPlus, Equal } from 'lucide-react';

interface Athlete {
  id: string;
  firstName: string;
  lastName: string;
  side?: string | null;
}

interface Seat {
  seatNumber: number;
  side: 'Port' | 'Starboard';
  athlete: Athlete | null;
  isCoxswain?: boolean;
}

interface Boat {
  id: string;
  name: string;
  boatClass: string;
  seats: Seat[];
  coxswain?: Athlete | null;
  hasCoxswain?: boolean;
}

interface LineupComparisonProps {
  lineup1: {
    id: string;
    name: string;
    boats: Boat[];
  };
  lineup2: {
    id: string;
    name: string;
    boats: Boat[];
  };
  className?: string;
}

type DiffType = 'same' | 'different' | 'added' | 'removed';

interface SeatComparison {
  seatNumber: number;
  isCoxswain: boolean;
  athlete1: Athlete | null;
  athlete2: Athlete | null;
  diffType: DiffType;
}

function getDiffType(athlete1: Athlete | null, athlete2: Athlete | null): DiffType {
  if (!athlete1 && !athlete2) return 'same';
  if (!athlete1 && athlete2) return 'added';
  if (athlete1 && !athlete2) return 'removed';
  if (athlete1!.id === athlete2!.id) return 'same';
  return 'different';
}

function getDiffColor(diffType: DiffType): string {
  switch (diffType) {
    case 'same':
      return 'border-bdr-default bg-bg-default';
    case 'different':
      return 'border-amber-500 bg-amber-500/10';
    case 'added':
      return 'border-green-500 bg-green-500/10';
    case 'removed':
      return 'border-red-500 bg-red-500/10';
    default:
      return 'border-bdr-default bg-bg-default';
  }
}

function DiffIcon({ diffType }: { diffType: DiffType }) {
  switch (diffType) {
    case 'same':
      return <Equal className="h-3.5 w-3.5 text-txt-tertiary" />;
    case 'different':
      return <ArrowLeftRight className="h-3.5 w-3.5 text-amber-500" />;
    case 'added':
      return <UserPlus className="h-3.5 w-3.5 text-green-500" />;
    case 'removed':
      return <UserMinus className="h-3.5 w-3.5 text-red-500" />;
    default:
      return null;
  }
}

function AthleteCell({
  athlete,
  isEmpty,
  className = '',
}: {
  athlete: Athlete | null;
  isEmpty: boolean;
  className?: string;
}) {
  if (!athlete) {
    return (
      <div className={`flex items-center gap-2 text-txt-tertiary ${className}`}>
        <User className="h-4 w-4 opacity-50" />
        <span className="text-sm italic">{isEmpty ? '(empty)' : '—'}</span>
      </div>
    );
  }

  return (
    <div className={`flex items-center gap-2 ${className}`}>
      <div
        className={`w-6 h-6 rounded-full flex items-center justify-center text-xs font-medium
                    ${
                      athlete.side === 'Port'
                        ? 'bg-red-500/10 text-red-600'
                        : athlete.side === 'Starboard'
                        ? 'bg-green-500/10 text-green-600'
                        : 'bg-bg-hover text-txt-secondary'
                    }`}
      >
        {athlete.firstName[0]}
        {athlete.lastName[0]}
      </div>
      <span className="text-sm text-txt-primary font-medium">
        {athlete.lastName}
      </span>
    </div>
  );
}

function SeatRow({ comparison }: { comparison: SeatComparison }) {
  const diffColor = getDiffColor(comparison.diffType);

  return (
    <motion.div
      initial={{ opacity: 0, y: 5 }}
      animate={{ opacity: 1, y: 0 }}
      className={`grid grid-cols-[1fr,auto,1fr] gap-2 p-2 rounded-lg border ${diffColor}`}
    >
      {/* Lineup 1 athlete */}
      <AthleteCell
        athlete={comparison.athlete1}
        isEmpty={comparison.diffType === 'added'}
      />

      {/* Seat indicator and diff icon */}
      <div className="flex flex-col items-center justify-center px-2">
        <span className="text-xs font-medium text-txt-secondary">
          {comparison.isCoxswain ? 'Cox' : comparison.seatNumber}
        </span>
        <DiffIcon diffType={comparison.diffType} />
      </div>

      {/* Lineup 2 athlete */}
      <AthleteCell
        athlete={comparison.athlete2}
        isEmpty={comparison.diffType === 'removed'}
        className="flex-row-reverse"
      />
    </motion.div>
  );
}

function BoatComparison({
  boat1,
  boat2,
}: {
  boat1: Boat | undefined;
  boat2: Boat | undefined;
}) {
  const comparisons = useMemo<SeatComparison[]>(() => {
    const result: SeatComparison[] = [];

    // Get all unique seat numbers from both boats
    const seatNumbers = new Set<number>();
    boat1?.seats.forEach((s) => seatNumbers.add(s.seatNumber));
    boat2?.seats.forEach((s) => seatNumbers.add(s.seatNumber));

    // Compare each seat
    const sortedSeats = Array.from(seatNumbers).sort((a, b) => b - a); // High to low (stroke to bow)
    for (const seatNum of sortedSeats) {
      const seat1 = boat1?.seats.find((s) => s.seatNumber === seatNum);
      const seat2 = boat2?.seats.find((s) => s.seatNumber === seatNum);

      result.push({
        seatNumber: seatNum,
        isCoxswain: false,
        athlete1: seat1?.athlete || null,
        athlete2: seat2?.athlete || null,
        diffType: getDiffType(seat1?.athlete || null, seat2?.athlete || null),
      });
    }

    // Compare coxswain if either boat has one
    if (boat1?.hasCoxswain || boat2?.hasCoxswain) {
      result.push({
        seatNumber: 0,
        isCoxswain: true,
        athlete1: boat1?.coxswain || null,
        athlete2: boat2?.coxswain || null,
        diffType: getDiffType(boat1?.coxswain || null, boat2?.coxswain || null),
      });
    }

    return result;
  }, [boat1, boat2]);

  const boatClass = boat1?.name || boat2?.name || 'Unknown';
  const diffCount = comparisons.filter((c) => c.diffType !== 'same').length;

  return (
    <div className="bg-bg-elevated rounded-lg border border-bdr-default overflow-hidden">
      {/* Boat header */}
      <div className="flex items-center justify-between p-3 bg-bg-default border-b border-bdr-default">
        <h4 className="font-medium text-txt-primary">{boatClass}</h4>
        {diffCount > 0 && (
          <span className="text-xs px-2 py-0.5 rounded-full bg-amber-500/10 text-amber-600">
            {diffCount} {diffCount === 1 ? 'difference' : 'differences'}
          </span>
        )}
      </div>

      {/* Seat comparisons */}
      <div className="p-3 space-y-2">
        {comparisons.map((comparison, idx) => (
          <SeatRow key={`${comparison.seatNumber}-${idx}`} comparison={comparison} />
        ))}
      </div>
    </div>
  );
}

export function LineupComparison({
  lineup1,
  lineup2,
  className = '',
}: LineupComparisonProps) {
  // Match boats by boat class for comparison
  const boatPairs = useMemo(() => {
    const pairs: Array<{ boat1?: Boat; boat2?: Boat; boatClass: string }> = [];
    const seen = new Set<string>();

    // Add all boats from lineup1
    for (const boat of lineup1.boats) {
      const matching = lineup2.boats.find(
        (b) => b.name === boat.name && !seen.has(b.id)
      );
      pairs.push({
        boat1: boat,
        boat2: matching,
        boatClass: boat.name,
      });
      if (matching) seen.add(matching.id);
    }

    // Add boats only in lineup2
    for (const boat of lineup2.boats) {
      if (!seen.has(boat.id)) {
        pairs.push({
          boat1: undefined,
          boat2: boat,
          boatClass: boat.name,
        });
      }
    }

    return pairs;
  }, [lineup1.boats, lineup2.boats]);

  const totalDiffs = useMemo(() => {
    // Count total differences across all boats
    let count = 0;
    for (const pair of boatPairs) {
      const seats1 = pair.boat1?.seats || [];
      const seats2 = pair.boat2?.seats || [];
      const allSeats = new Set([
        ...seats1.map((s) => s.seatNumber),
        ...seats2.map((s) => s.seatNumber),
      ]);

      for (const seatNum of allSeats) {
        const s1 = seats1.find((s) => s.seatNumber === seatNum);
        const s2 = seats2.find((s) => s.seatNumber === seatNum);
        if (getDiffType(s1?.athlete || null, s2?.athlete || null) !== 'same') {
          count++;
        }
      }

      // Check coxswain
      if (pair.boat1?.hasCoxswain || pair.boat2?.hasCoxswain) {
        if (
          getDiffType(
            pair.boat1?.coxswain || null,
            pair.boat2?.coxswain || null
          ) !== 'same'
        ) {
          count++;
        }
      }
    }
    return count;
  }, [boatPairs]);

  return (
    <div className={className}>
      {/* Header with lineup names */}
      <div className="grid grid-cols-[1fr,auto,1fr] gap-4 mb-4">
        <div className="text-center">
          <h3 className="font-semibold text-txt-primary">{lineup1.name}</h3>
        </div>
        <div className="flex items-center justify-center">
          <div className="px-3 py-1 rounded-full bg-bg-elevated border border-bdr-default">
            <span className="text-sm text-txt-secondary">
              {totalDiffs === 0
                ? 'Identical'
                : `${totalDiffs} ${totalDiffs === 1 ? 'difference' : 'differences'}`}
            </span>
          </div>
        </div>
        <div className="text-center">
          <h3 className="font-semibold text-txt-primary">{lineup2.name}</h3>
        </div>
      </div>

      {/* Boat comparisons */}
      <div className="space-y-4">
        {boatPairs.map((pair, idx) => (
          <BoatComparison
            key={`${pair.boatClass}-${idx}`}
            boat1={pair.boat1}
            boat2={pair.boat2}
          />
        ))}
      </div>
    </div>
  );
}

export default LineupComparison;
```
  </action>
  <verify>Run `npx tsc --noEmit src/v2/features/lineup/components/LineupComparison.tsx` - should compile without errors.</verify>
  <done>LineupComparison component created with seat-by-seat diff and color coding.</done>
</task>

<task type="auto">
  <name>Task 3: Export new components</name>
  <files>src/v2/features/lineup/components/index.ts</files>
  <action>
Update `src/v2/features/lineup/components/index.ts` to include new exports:

```typescript
// Phase 18 components
export { RiggingPanel } from './RiggingPanel';
export { EquipmentPicker } from './EquipmentPicker';
export { TemplateManager } from './TemplateManager';
export { LineupComparison } from './LineupComparison';
```
  </action>
  <verify>Run `npx tsc --noEmit src/v2/features/lineup/components/index.ts` - should compile without errors.</verify>
  <done>TemplateManager and LineupComparison exported from index.</done>
</task>

</tasks>

<verification>
- [ ] `npx tsc --noEmit src/v2/features/lineup/components/TemplateManager.tsx` passes
- [ ] `npx tsc --noEmit src/v2/features/lineup/components/LineupComparison.tsx` passes
- [ ] Components exported from index.ts
- [ ] TemplateManager uses template hooks
- [ ] LineupComparison highlights differences correctly
</verification>

<success_criteria>
1. TemplateManager can save current lineup as template
2. TemplateManager lists and applies existing templates
3. LineupComparison shows two lineups side-by-side
4. Differences highlighted with color coding (added=green, removed=red, changed=amber)
</success_criteria>

<output>
After completion, create `.planning/phases/18-lineup-boat-improvements/18-09-SUMMARY.md`
</output>
