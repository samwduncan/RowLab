---
phase: 18-lineup-boat-improvements
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - prisma/schema.prisma
autonomous: true

must_haves:
  truths:
    - "xlsx and qrcode.react are installed"
    - "Prisma schema has RiggingProfile and LineupTemplate models"
    - "Database migration runs successfully"
  artifacts:
    - path: "package.json"
      provides: "New dependencies"
      contains: "xlsx"
    - path: "prisma/schema.prisma"
      provides: "RiggingProfile, LineupTemplate models"
      contains: "model RiggingProfile"
  key_links:
    - from: "prisma/schema.prisma"
      to: "Shell, BoatConfig"
      via: "Foreign key relations"
      pattern: "riggingProfile.*Shell"
---

<objective>
Install dependencies and create database schema for rigging profiles and lineup templates.

Purpose: Foundation for all Phase 18 features - libraries for Excel/QR export and database models for rigging/template storage.
Output: Updated package.json with dependencies, Prisma schema with new models, successful db push.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-lineup-boat-improvements/18-RESEARCH.md
@prisma/schema.prisma
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install npm dependencies</name>
  <files>package.json</files>
  <action>
Install the following packages:
- xlsx (SheetJS) for Excel export (~400kb, will be lazy-loaded)
- qrcode.react for QR code generation in PDFs
- @tanstack/react-virtual (if not already installed - for virtualized lineup lists)

Run: `npm install xlsx qrcode.react`

Check if @tanstack/react-virtual is already installed. If not, add it.

Do NOT add react-diff-viewer - the research recommends simple side-by-side comparison over diff algorithms.
  </action>
  <verify>Run `npm ls xlsx qrcode.react @tanstack/react-virtual` - all packages should be listed without UNMET PEER DEPENDENCY warnings.</verify>
  <done>xlsx, qrcode.react installed and listed in package.json dependencies.</done>
</task>

<task type="auto">
  <name>Task 2: Add Prisma schema models</name>
  <files>prisma/schema.prisma</files>
  <action>
Add the following models to schema.prisma:

1. **RiggingProfile** - Store rigging settings per shell
```prisma
model RiggingProfile {
  id        String   @id @default(cuid())
  shellId   String   @unique
  teamId    String
  defaults  Json     // { spread, span, catchAngle, finishAngle, oarLength, inboard, pitch, gateHeight }
  perSeat   Json?    // Optional per-seat overrides: { "1": { spread: 86 }, ... }
  notes     String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  shell Shell @relation(fields: [shellId], references: [id], onDelete: Cascade)
  team  Team  @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@index([teamId])
  @@map("rigging_profiles")
}
```

2. **LineupTemplate** - Save lineups as reusable templates
```prisma
model LineupTemplate {
  id           String   @id @default(cuid())
  teamId       String
  name         String
  description  String?
  boatClass    String
  assignments  Json     // Array of { seatNumber, side, preferredAthleteId? }
  rigging      Json?    // Optional rigging snapshot
  isDefault    Boolean  @default(false)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  team Team @relation(fields: [teamId], references: [id], onDelete: Cascade)

  @@unique([teamId, name])
  @@index([teamId])
  @@map("lineup_templates")
}
```

3. **EquipmentAssignment** - Track equipment usage for conflict detection
```prisma
model EquipmentAssignment {
  id           String   @id @default(cuid())
  teamId       String
  lineupId     String?
  sessionId    String?  // Link to Session if used in practice
  shellId      String?
  oarSetId     String?
  assignedDate DateTime @db.Date
  notes        String?
  createdAt    DateTime @default(now())

  team   Team     @relation(fields: [teamId], references: [id], onDelete: Cascade)
  lineup Lineup?  @relation(fields: [lineupId], references: [id], onDelete: SetNull)
  shell  Shell?   @relation(fields: [shellId], references: [id], onDelete: SetNull)
  oarSet OarSet?  @relation(fields: [oarSetId], references: [id], onDelete: SetNull)

  @@index([teamId, assignedDate])
  @@index([shellId, assignedDate])
  @@map("equipment_assignments")
}
```

4. Update **Shell** model to add relation:
```prisma
// Add to Shell model:
riggingProfile RiggingProfile?
assignments    EquipmentAssignment[]
```

5. Update **OarSet** model to add relation:
```prisma
// Add to OarSet model:
assignments EquipmentAssignment[]
```

6. Update **Lineup** model to add relation:
```prisma
// Add to Lineup model:
equipmentAssignments EquipmentAssignment[]
```

7. Update **Team** model to add relations:
```prisma
// Add to Team model:
riggingProfiles     RiggingProfile[]
lineupTemplates     LineupTemplate[]
equipmentAssignments EquipmentAssignment[]
```
  </action>
  <verify>Run `npx prisma validate` - should complete without errors.</verify>
  <done>All 3 new models added with proper relations to existing models.</done>
</task>

<task type="auto">
  <name>Task 3: Run database migration</name>
  <files>prisma/schema.prisma</files>
  <action>
Run database push to apply schema changes:

```bash
npx prisma db push
```

Note: Using db push (not migrate) per Phase 6 decision - database has drift from migration history.

After push, generate updated Prisma client:

```bash
npx prisma generate
```
  </action>
  <verify>Run `npx prisma db push` and `npx prisma generate` - both should complete without errors. Run `npx prisma studio` briefly to verify new tables exist (RiggingProfile, LineupTemplate, EquipmentAssignment).</verify>
  <done>Database schema updated, Prisma client regenerated, new tables visible in Prisma Studio.</done>
</task>

</tasks>

<verification>
- [ ] `npm ls xlsx qrcode.react` shows packages installed
- [ ] `npx prisma validate` passes
- [ ] `npx prisma db push` completes successfully
- [ ] Prisma Studio shows rigging_profiles, lineup_templates, equipment_assignments tables
</verification>

<success_criteria>
1. All npm packages installed without errors
2. Prisma schema validates successfully
3. Database migration completes
4. New tables are queryable via Prisma Studio
</success_criteria>

<output>
After completion, create `.planning/phases/18-lineup-boat-improvements/18-01-SUMMARY.md`
</output>
